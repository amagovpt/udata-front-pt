<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Campos: DGT (SNIG) para uData Database</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --code-bg: #f8fafc;
            --code-text: #0f172a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 64px;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.04em;
            margin-top: 0;
            margin-bottom: 2rem;
            color: #0f172a;
            line-height: 1.1;
        }

        h1::after {
            content: '';
            display: block;
            width: 80px;
            height: 6px;
            background: var(--primary);
            margin-top: 1rem;
            border-radius: 3px;
        }

        h2 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-top: 3.5rem;
            margin-bottom: 1.25rem;
            color: #0f172a;
            letter-spacing: -0.02em;
        }

        h3 {
            font-size: 1.35rem;
            font-weight: 600;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            color: #1e293b;
        }

        h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            color: #334155;
        }

        p {
            margin-bottom: 1.25rem;
            font-size: 1.05rem;
            color: #334155;
        }

        strong {
            color: #0f172a;
            font-weight: 600;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
            color: #2563eb;
        }

        pre {
            background-color: #0f172a;
            color: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }

        pre code {
            background: transparent;
            border: none;
            padding: 0;
            color: inherit;
            font-size: inherit;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 2.5rem 0;
            font-size: 0.95rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            text-align: left;
            padding: 14px 20px;
            border-bottom: 2px solid var(--border-color);
            color: #475569;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #f8fafc;
        }

        @media (max-width: 768px) {
            .container {
                padding: 32px;
            }

            h1 {
                font-size: 2rem;
            }

            table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Mapa de Campos: DGT (SNIG) para uData Database</h1>
        <p>Este documento mapeia os campos obtidos do harvester <code>DGTBackend</code> (Sistema Nacional de Informação
            Geográfica - SNIG) para os campos da tabela/coleção <code>datasets</code> na base de dados do uData (modelo
            <code>Dataset</code>).</p>
        <h2>Fonte de Dados</h2>
        <p><strong>API SNIG</strong>: Direção-Geral do Território (DGT)
            - URL exemplo:
            <code>https://snig.dgterritorio.gov.pt/rndg/srv/por/q?_content_type=json&amp;fast=index&amp;from=1&amp;resultType=details&amp;sortBy=referenceDateOrd&amp;type=dataset+or+series&amp;dataPolicy=Dados%20abertos&amp;keyword=DGT</code>
            - Protocolo: API JSON customizada (GeoNetwork)
            - Formato de resposta: JSON com estrutura específica do GeoNetwork</p>
        <h2>Resumo do Mapeamento</h2>
        <table>
            <thead>
                <tr>
                    <th style="text-align: left;">Campo Fonte (SNIG JSON)</th>
                    <th style="text-align: left;">Propriedade JSON</th>
                    <th style="text-align: left;">Campo Destino (uData <code>Dataset</code>)</th>
                    <th style="text-align: left;">Notas / Lógica</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="text-align: left;"><strong>Dataset</strong></td>
                    <td style="text-align: left;"></td>
                    <td style="text-align: left;"></td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>geonet:info.uuid</code></td>
                    <td style="text-align: left;"><code>each['geonet:info']['uuid']</code></td>
                    <td style="text-align: left;"><code>remote_id</code> (HarvestItem)</td>
                    <td style="text-align: left;">UUID do registo no GeoNetwork.</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>defaultTitle</code></td>
                    <td style="text-align: left;"><code>each['defaultTitle']</code></td>
                    <td style="text-align: left;"><code>title</code></td>
                    <td style="text-align: left;">Título do dataset.</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>defaultAbstract</code></td>
                    <td style="text-align: left;"><code>each['defaultAbstract']</code></td>
                    <td style="text-align: left;"><code>description</code></td>
                    <td style="text-align: left;">Descrição/resumo do dataset.</td>
                </tr>
                <tr>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;"><code>license</code></td>
                    <td style="text-align: left;">Fixo: <code>cc-by</code> (Creative Commons Attribution).</td>
                </tr>
                <tr>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;"><code>tags</code></td>
                    <td style="text-align: left;">Fixo: <code>["snig.dgterritorio.gov.pt"]</code>.</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>keyword</code></td>
                    <td style="text-align: left;"><code>each['keyword']</code></td>
                    <td style="text-align: left;"><code>tags</code></td>
                    <td style="text-align: left;">Keywords adicionadas às tags.</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>publicationDate</code></td>
                    <td style="text-align: left;"><code>each['publicationDate']</code></td>
                    <td style="text-align: left;"><code>created_at</code></td>
                    <td style="text-align: left;">Data de publicação (comentado).</td>
                </tr>
                <tr>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;"><code>extras['harvest:name']</code></td>
                    <td style="text-align: left;">Nome da fonte de harvest.</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><strong>Resource</strong></td>
                    <td style="text-align: left;"><code>each['link']</code></td>
                    <td style="text-align: left;"><strong>Resource</strong></td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>link</code> (pipe-separated)</td>
                    <td style="text-align: left;">Posição 2</td>
                    <td style="text-align: left;"><code>url</code></td>
                    <td style="text-align: left;">URL do recurso (normalizada).</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>link</code> (pipe-separated)</td>
                    <td style="text-align: left;">Posição 3</td>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;">Tipo (não usado).</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>link</code> (pipe-separated)</td>
                    <td style="text-align: left;">Posição 4</td>
                    <td style="text-align: left;"><code>format</code></td>
                    <td style="text-align: left;">Formato do recurso.</td>
                </tr>
                <tr>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;"><code>title</code></td>
                    <td style="text-align: left;">Reutiliza o título do dataset.</td>
                </tr>
                <tr>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;"><code>filetype</code></td>
                    <td style="text-align: left;">Fixo: <code>'remote'</code>.</td>
                </tr>
            </tbody>
        </table>
        <h2>Detalhes Específicos</h2>
        <h3>1. Estrutura da Resposta JSON</h3>
        <p>A API retorna uma estrutura com metadados que pode ser:
            - <strong>Dict único</strong>: Convertido para lista <code>[metadata]</code>
            - <strong>Lista de dicts</strong>: Processada diretamente
            - <strong>String</strong>: Erro (não processável)
            - <strong>Vazio</strong>: Erro (sem datasets)</p>
        <pre><code class="language-python">metadata = data.get(&quot;metadata&quot;)
if isinstance(metadata, dict):
    metadata = [metadata]
elif isinstance(metadata, str):
    raise Exception(&quot;metadata é uma string, não um dict&quot;)
</code></pre>
        <h3>2. Identificador do Dataset</h3>
        <p>O UUID é extraído do objeto aninhado <code>geonet:info</code>:</p>
        <pre><code class="language-python">remote_id = each.get(&quot;geonet:info&quot;, {}).get(&quot;uuid&quot;)
</code></pre>
        <h3>3. Licença</h3>
        <p>Todos os datasets recebem automaticamente a licença <strong>CC-BY</strong>:</p>
        <pre><code class="language-python">dataset.license = License.guess('cc-by')
</code></pre>
        <h3>4. Tags</h3>
        <p>As tags incluem:
            - Tag fixa de identificação: <code>"snig.dgterritorio.gov.pt"</code>
            - Keywords do metadata: <code>each.get('keyword')</code></p>
        <pre><code class="language-python">dataset.tags = [&quot;snig.dgterritorio.gov.pt&quot;]
for keyword in item.get('keywords'):
    dataset.tags.append(keyword)
</code></pre>
        <h3>5. Recursos (Resources)</h3>
        <h4>5.1 Formato Pipe-Separated</h4>
        <p>Os recursos vêm numa string separada por pipes (<code>|</code>):</p>
        <pre><code>nome|descrição|URL|tipo|formato
</code></pre>
        <p>Exemplo:</p>
        <pre><code>WMS Service|Serviço WMS|https://example.pt/wms?service=WMS|OGC:WMS|WMS
</code></pre>
        <h4>5.2 Parsing de Links</h4>
        <p>O harvester processa tanto listas quanto strings individuais:</p>
        <p><strong>Lista de recursos:</strong></p>
        <pre><code class="language-python">if isinstance(resources, list):
    for url in resources:
        url_parts = url.split('|')
        inner_link = {
            'url': url_parts[2],
            'type': url_parts[3],
            'format': url_parts[4]
        }
        links.append(inner_link)
</code></pre>
        <p><strong>Recurso único:</strong></p>
        <pre><code class="language-python">elif isinstance(resources, str):
    url_parts = resources.split('|')
    inner_link = {
        'url': url_parts[2],
        'type': url_parts[3],
        'format': url_parts[4]
    }
    links.append(inner_link)
</code></pre>
        <h4>5.3 Determinação do Formato</h4>
        <p>O formato é determinado por duas estratégias:</p>
        <p><strong>1. Extração do parâmetro <code>service</code> da query string:</strong></p>
        <pre><code class="language-python">parsed = urlparse.urlparse(resource['url'])
format = str(urlparse.parse_qs(parsed.query)['service'][0])
</code></pre>
        <p><strong>2. Fallback para extensão do ficheiro:</strong></p>
        <pre><code class="language-python">except KeyError:
    format = resource['url'].split('.')[-1]
</code></pre>
        <p>Isto permite identificar serviços OGC (WMS, WFS, etc.) através do parâmetro <code>service</code>.</p>
        <h4>5.4 Recriação de Recursos</h4>
        <p>O harvester <strong>força a recriação</strong> de todos os recursos:</p>
        <pre><code class="language-python">dataset.resources = []
</code></pre>
        <h3>6. Data de Publicação (Desativada)</h3>
        <p>O código para processar a data de publicação está comentado:</p>
        <pre><code class="language-python"># if each.get(&quot;publicationDate&quot;):
#     item[&quot;date&quot;] = datetime.strptime(each.get(&quot;publicationDate&quot;), &quot;%Y-%m-%d&quot;)
</code></pre>
        <h3>7. Validação de Metadados</h3>
        <p>O harvester valida que os metadados não estão vazios:</p>
        <pre><code class="language-python">if not metadata:
    raise Exception('Erro: Metadados vazios. Nenhum dataset disponível.')
</code></pre>
        <h2>Exemplo de Mapeamento</h2>
        <h3>Resposta SNIG API (simplificado)</h3>
        <pre><code class="language-json">{
  &quot;metadata&quot;: {
    &quot;geonet:info&quot;: {
      &quot;uuid&quot;: &quot;a1b2c3d4-e5f6-7890-abcd-ef1234567890&quot;
    },
    &quot;defaultTitle&quot;: &quot;Carta de Uso e Ocupação do Solo&quot;,
    &quot;defaultAbstract&quot;: &quot;Carta de uso e ocupação do solo de Portugal Continental&quot;,
    &quot;keyword&quot;: [&quot;uso do solo&quot;, &quot;ocupação&quot;, &quot;cartografia&quot;],
    &quot;link&quot;: [
      &quot;WMS|Serviço WMS|https://snig.dgterritorio.gov.pt/wms?service=WMS|OGC:WMS|WMS&quot;,
      &quot;Download|Ficheiro Shapefile|https://snig.dgterritorio.gov.pt/data/cos.zip|download|ZIP&quot;
    ]
  }
}
</code></pre>
        <h3>Dataset uData resultante</h3>
        <pre><code class="language-python">dataset.title = &quot;Carta de Uso e Ocupação do Solo&quot;
dataset.description = &quot;Carta de uso e ocupação do solo de Portugal Continental&quot;
dataset.license = License('cc-by')
dataset.tags = [
    &quot;snig.dgterritorio.gov.pt&quot;,
    &quot;uso do solo&quot;,
    &quot;ocupação&quot;,
    &quot;cartografia&quot;
]
dataset.extras = {
    'harvest:name': 'Nome da Fonte DGT'
}
dataset.resources = [
    Resource(
        title=&quot;Carta de Uso e Ocupação do Solo&quot;,
        url=&quot;https://snig.dgterritorio.gov.pt/wms?service=WMS&quot;,
        filetype=&quot;remote&quot;,
        format=&quot;WMS&quot;  # Extraído do parâmetro service
    ),
    Resource(
        title=&quot;Carta de Uso e Ocupação do Solo&quot;,
        url=&quot;https://snig.dgterritorio.gov.pt/data/cos.zip&quot;,
        filetype=&quot;remote&quot;,
        format=&quot;zip&quot;  # Extraído da extensão
    )
]
</code></pre>
        <h2>Campos Não Mapeados</h2>
        <p>Os seguintes campos típicos <strong>não são mapeados</strong> neste harvester:
            - <code>publicationDate</code> (comentado, não usado)
            - <code>type</code> do link (extraído mas não usado)
            - Cobertura espacial (<code>spatial</code>)
            - Cobertura temporal (<code>temporal_coverage</code>)
            - Organização (<code>organization</code>)
            - Frequência de atualização (<code>frequency</code>)</p>
        <h2>Particularidades do GeoNetwork</h2>
        <p>Este harvester é específico para a API do GeoNetwork usada pela DGT:
            - Formato de links pipe-separated é específico desta implementação
            - Estrutura <code>geonet:info</code> é própria do GeoNetwork
            - Suporta serviços OGC (WMS, WFS, WCS) através da detecção do parâmetro <code>service</code></p>
    </div>
</body>

</html>