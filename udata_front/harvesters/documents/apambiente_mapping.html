<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Campos: Portal do Ambiente (CSW) para uData Database</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --code-bg: #f8fafc;
            --code-text: #0f172a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 64px;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.04em;
            margin-top: 0;
            margin-bottom: 2rem;
            color: #0f172a;
            line-height: 1.1;
        }

        h1::after {
            content: '';
            display: block;
            width: 80px;
            height: 6px;
            background: var(--primary);
            margin-top: 1rem;
            border-radius: 3px;
        }

        h2 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-top: 3.5rem;
            margin-bottom: 1.25rem;
            color: #0f172a;
            letter-spacing: -0.02em;
        }

        h3 {
            font-size: 1.35rem;
            font-weight: 600;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            color: #1e293b;
        }

        h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            color: #334155;
        }

        p {
            margin-bottom: 1.25rem;
            font-size: 1.05rem;
            color: #334155;
        }

        strong {
            color: #0f172a;
            font-weight: 600;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
            color: #2563eb;
        }

        pre {
            background-color: #0f172a;
            color: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }

        pre code {
            background: transparent;
            border: none;
            padding: 0;
            color: inherit;
            font-size: inherit;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 2.5rem 0;
            font-size: 0.95rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            text-align: left;
            padding: 14px 20px;
            border-bottom: 2px solid var(--border-color);
            color: #475569;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #f8fafc;
        }

        @media (max-width: 768px) {
            .container {
                padding: 32px;
            }

            h1 {
                font-size: 2rem;
            }

            table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Mapa de Campos: Portal do Ambiente (CSW) para uData Database</h1>
        <p>Este documento mapeia os campos obtidos do harvester <code>PortalAmbienteBackend</code> (CSW - Catalogue
            Service for the Web) para os campos da tabela/coleção <code>datasets</code> na base de dados do uData
            (modelo <code>Dataset</code>).</p>
        <h2>Fonte de Dados</h2>
        <p><strong>Endpoint CSW</strong>: Portal do Ambiente (APA - Agência Portuguesa do Ambiente)
            - URL exemplo: <code>https://sniambgeoportal.apambiente.pt/geoportal/csw</code>
            - Protocolo: CSW (OGC Catalogue Service for the Web)
            - Biblioteca: OWSLib (<code>owslib.csw.CatalogueServiceWeb</code>)</p>
        <h2>Resumo do Mapeamento</h2>
        <table>
            <thead>
                <tr>
                    <th style="text-align: left;">Campo Fonte (CSW Record)</th>
                    <th style="text-align: left;">Propriedade OWSLib</th>
                    <th style="text-align: left;">Campo Destino (uData <code>Dataset</code>)</th>
                    <th style="text-align: left;">Notas / Lógica</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="text-align: left;"><strong>Dataset</strong></td>
                    <td style="text-align: left;"></td>
                    <td style="text-align: left;"></td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>identifier</code></td>
                    <td style="text-align: left;"><code>record.identifier</code></td>
                    <td style="text-align: left;"><code>remote_id</code> (HarvestItem)</td>
                    <td style="text-align: left;">Identificador único do registo CSW.</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>title</code></td>
                    <td style="text-align: left;"><code>record.title</code></td>
                    <td style="text-align: left;"><code>title</code></td>
                    <td style="text-align: left;">Título do dataset.</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>abstract</code></td>
                    <td style="text-align: left;"><code>record.abstract</code></td>
                    <td style="text-align: left;"><code>description</code></td>
                    <td style="text-align: left;">Descrição do dataset.</td>
                </tr>
                <tr>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;"><code>license</code></td>
                    <td style="text-align: left;">Fixo: <code>cc-by</code> (Creative Commons Attribution).</td>
                </tr>
                <tr>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;"><code>tags</code></td>
                    <td style="text-align: left;">Fixo: <code>["apambiente.pt"]</code>.</td>
                </tr>
                <tr>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;"><code>item.get('date')</code></td>
                    <td style="text-align: left;"><code>created_at</code></td>
                    <td style="text-align: left;">Data de criação (se disponível).</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><strong>Resource</strong></td>
                    <td style="text-align: left;"></td>
                    <td style="text-align: left;"></td>
                    <td style="text-align: left;"></td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>references[0]['url']</code></td>
                    <td style="text-align: left;"><code>record.references[0].get('url')</code></td>
                    <td style="text-align: left;"><code>url</code></td>
                    <td style="text-align: left;">URL do recurso (normalizada).</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>title</code></td>
                    <td style="text-align: left;"><code>record.title</code></td>
                    <td style="text-align: left;"><code>title</code></td>
                    <td style="text-align: left;">Reutiliza o título do dataset.</td>
                </tr>
                <tr>
                    <td style="text-align: left;"><code>type</code></td>
                    <td style="text-align: left;"><code>record.type</code></td>
                    <td style="text-align: left;"><code>format</code></td>
                    <td style="text-align: left;">Determina o formato do recurso.</td>
                </tr>
                <tr>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;">-</td>
                    <td style="text-align: left;"><code>filetype</code></td>
                    <td style="text-align: left;">Fixo: <code>remote</code>.</td>
                </tr>
            </tbody>
        </table>
        <h2>Detalhes Específicos</h2>
        <h3>1. Identificador do Dataset</h3>
        <p>O <code>identifier</code> do registo CSW é usado como <code>remote_id</code> no <code>HarvestItem</code>,
            permitindo a identificação única do dataset durante a harvest.</p>
        <h3>2. Licença</h3>
        <p>O harvester atribui automaticamente a licença <strong>CC-BY</strong> (Creative Commons Attribution) a todos
            os datasets colhidos:</p>
        <pre><code class="language-python">dataset.license = License.guess('cc-by')
</code></pre>
        <h3>3. Tags</h3>
        <p>Todos os datasets recebem a tag <code>"apambiente.pt"</code> para identificação da fonte:</p>
        <pre><code class="language-python">dataset.tags = [&quot;apambiente.pt&quot;]
</code></pre>
        <h3>4. Recursos (Resources)</h3>
        <h4>4.1 URL do Recurso</h4>
        <p>A URL é extraída do primeiro elemento em <code>record.references</code> e normalizada:</p>
        <pre><code class="language-python">item[&quot;url&quot;] = normalize_url_slashes(record.references[0].get('url'))
</code></pre>
        <h4>4.2 Formato do Recurso</h4>
        <p>O formato é determinado pela propriedade <code>type</code> do registo CSW:
            - Se <code>type == "liveData"</code> → formato = <code>"wms"</code> (Web Map Service)
            - Caso contrário, extrai a extensão da URL:
            - Se a extensão tiver mais de 3 caracteres → formato = <code>"wms"</code>
            - Caso contrário, usa a extensão como formato (ex: <code>pdf</code>, <code>xml</code>, <code>zip</code>)</p>
        <pre><code class="language-python">if item.get('type') == &quot;liveData&quot;:
    type = &quot;wms&quot;
else:
    type = url.split('.')[-1].lower()
    if len(type) &gt; 3:
        type = &quot;wms&quot;
</code></pre>
        <h4>4.3 Recriação de Recursos</h4>
        <p>O harvester <strong>força a recriação</strong> de todos os recursos a cada execução:</p>
        <pre><code class="language-python">dataset.resources = []
</code></pre>
        <p>Isto significa que os recursos existentes são substituídos pelos novos dados colhidos.</p>
        <h3>5. Campos Não Mapeados</h3>
        <p>Os seguintes campos típicos de CSW <strong>não são mapeados</strong> neste harvester:
            - <code>spatial</code> (cobertura espacial)
            - <code>temporal</code> (cobertura temporal)
            - <code>keywords</code> (palavras-chave do CSW)
            - <code>contact</code> (informação de contacto)
            - <code>modified</code> (data de modificação)</p>
        <h3>6. Paginação</h3>
        <p>O harvester processa os registos em lotes de 100:</p>
        <pre><code class="language-python">csw.getrecords2(maxrecords=100, startposition=startposition)
</code></pre>
        <h2>Exemplo de Mapeamento</h2>
        <h3>Registo CSW (simplificado)</h3>
        <pre><code class="language-python">record.identifier = &quot;12345-abcd-6789&quot;
record.title = &quot;Áreas Protegidas de Portugal&quot;
record.abstract = &quot;Delimitação das áreas protegidas...&quot;
record.type = &quot;liveData&quot;
record.references = [{'url': 'https://example.pt/wms?service=WMS'}]
</code></pre>
        <h3>Dataset uData resultante</h3>
        <pre><code class="language-python">dataset.title = &quot;Áreas Protegidas de Portugal&quot;
dataset.description = &quot;Delimitação das áreas protegidas...&quot;
dataset.license = License('cc-by')
dataset.tags = [&quot;apambiente.pt&quot;]
dataset.resources = [
    Resource(
        title=&quot;Áreas Protegidas de Portugal&quot;,
        url=&quot;https://example.pt/wms?service=WMS&quot;,
        filetype=&quot;remote&quot;,
        format=&quot;wms&quot;
    )
]
</code></pre>
    </div>
</body>

</html>