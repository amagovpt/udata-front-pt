import requests
import os
import sys
import urllib3
import json
from dotenv import load_dotenv

# Adiciona o diret√≥rio raiz ao path para poder importar udata_front
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), "../..")))

try:
    from udata_front.security import sanitize_svg
except ImportError:
    print("ERRO: N√£o foi poss√≠vel importar udata_front.security.")
    sys.exit(1)

# Suppress InsecureRequestWarning
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

load_dotenv()

BASE_URL = os.getenv("UDATA_BASE_URL", "http://preprod.dados.gov.pt/api/1/")
DATASET_ID = os.getenv("EXPORT_CSV_DATASET_ID", "67c5a3b3b50fe67ba7aa1905")
API_KEY = os.getenv("UDATA_API_KEY")

# Configura√ß√£o dos Endpoints
ENDPOINTS = [
    {
        "name": "Resources Endpoint",
        "url": f"{BASE_URL}datasets/{DATASET_ID}/resources/",
    },
    {
        "name": "Community Upload Endpoint",
        "url": f"{BASE_URL}datasets/{DATASET_ID}/resources/upload/community/",
    },
]

# Configura√ß√£o dos Payloads
PAYLOADS = [
    {
        "type": "SVG (XSS)",
        "file": "malicious_xss.svg",
        "mime": "image/svg+xml",
        "content": """<svg xmlns="http://www.w3.org/2000/svg">
  <script>alert('XSS Exploit');</script>
  <circle cx="50" cy="50" r="40" fill="blue" />
</svg>""",
    },
    {
        "type": "XML (XXE)",
        "file": "malicious_xxe.xml",
        "mime": "application/xml",
        "content": """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<svg xmlns="http://www.w3.org/2000/svg">
  <text>&xxe;</text>
</svg>""",
    },
    {
        "type": "XML Disguised SVG (XSS)",
        "file": "disguised_xss.xml",
        "mime": "application/xml",
        "content": """<svg xmlns="http://www.w3.org/2000/svg">
  <script>alert('XSS via XML extension');</script>
  <rect width="100" height="100" fill="green" />
</svg>""",
    },
    {
        "type": "XML Disguised SVG (XSS) 2",
        "file": "disguised_xss2.xml",
        "mime": "application/xml",
        "content": """<svg xmlns="http://www.w3.org/2000/svg" viewBox="-52 -53 100 100" stroke-width="2">
 <g fill="none">
  <ellipse stroke="#66899a" rx="6" ry="44"/>
  <ellipse stroke="#e1d85d" rx="6" ry="44" transform="rotate(-66)"/>
  <ellipse stroke="#80a3cf" rx="6" ry="44" transform="rotate(66)"/>
  <circle stroke="#4b541f" r="44"/>
 </g>
 <script type="text/javascript">
  alert('XSS')
 </script>
 <g fill="#66899a" stroke="white">
  <circle fill="#80a3cf" r="13"/>
  <circle cy="-44" r="9"/>
  <circle cx="-40" cy="18" r="9"/>
  <circle cx="40" cy="18" r="9"/>
 </g>
</svg>""",
    },
]


def run_test(payload, endpoint):
    test_name = f"{payload['type']} -> {endpoint['name']}"
    print(f"\n[ TESTE ] Payload: {payload['type']} -> Endpoint: {endpoint['name']}")
    print(f"URL: {endpoint['url']} | Ficheiro: {payload['file']}")

    content_bytes = payload["content"].encode("utf-8")

    # --- VERIFICA√á√ÉO DE SEGURAN√áA (udata_front/security.py) ---
    security_passed = True
    print(">> Verifica√ß√£o de Seguran√ßa Local (sanitize_svg)...")
    try:
        sanitized = sanitize_svg(content_bytes)
        if sanitized != content_bytes:
            print(">> ‚ö†Ô∏è  SEGURAN√áA: Conte√∫do malicioso detectado e removido!")
            security_passed = False
        else:
            print(">> ‚úÖ SEGURAN√áA: Nenhuma amea√ßa detectada localmente.")
    except Exception as e:
        print(f">> ‚ùå SEGURAN√áA: Ficheiro rejeitado! Erro: {e}")
        security_passed = False

    # Mensagem de conformidade com o pedido: "n√£o permitir que fa√ßa o ficheiro caso seja malicioso"
    if not security_passed:
        print(
            f">> üö´ BLOQUEIO: O envio de '{payload['file']}' foi bloqueado devido ao conte√∫do malicioso."
        )
        return {"name": test_name, "status": "‚úÖ PASSOU (Bloqueado localmente)"}

    # --- TENTATIVA DE UPLOAD ---
    print(">> A tentar realizar o upload...")
    files = {"file": (payload["file"], content_bytes, payload["mime"])}
    headers = {"X-API-KEY": API_KEY}
    data = {"title": f"Teste {payload['type']}", "filename": payload["file"]}

    try:
        response = requests.post(
            endpoint["url"], files=files, data=data, headers=headers, verify=False
        )
        print(f">> Status: {response.status_code}")
        print(f">> Resposta: {response.text[:150]}...")
        if response.status_code >= 400:
            return {
                "name": test_name,
                "status": f"‚úÖ PASSOU (Bloqueado pela API - {response.status_code})",
            }
        else:
            return {
                "name": test_name,
                "status": "‚ùå FALHOU (Ficheiro aceite com sucesso!)",
            }
    except Exception as e:
        print(f">> ERRO Connection: {e}")
        return {"name": test_name, "status": f"‚ö†Ô∏è ERRO DE LIGA√á√ÉO ({e})"}


if __name__ == "__main__":
    resultados = []
    for payload in PAYLOADS:
        for endpoint in ENDPOINTS:
            res = run_test(payload, endpoint)
            resultados.append(res)

    # --- RESUMO FINAL ---
    print("\n" + "=" * 60)
    print("RESUMO FINAL DOS TESTES".center(60))
    print("=" * 60)

    passaram = sum(1 for r in resultados if "‚úÖ PASSOU" in r["status"])
    falharam = sum(1 for r in resultados if "‚ùå FALHOU" in r["status"])
    erros = len(resultados) - passaram - falharam

    for r in resultados:
        print(f"- {r['name']}")
        print(f"  Resultado: {r['status']}\n")

    print("-" * 60)
    print(
        f"Total: {len(resultados)} | Passaram: {passaram} | Falharam: {falharam} | Erros: {erros}"
    )
    print("=" * 60)

    print("\n[ FIM ] Todos os testes conclu√≠dos.")
